<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUIC-RTC Meeting Room</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="room-page">
    <div id="app" class="room-container">

        <!-- Loading State -->
        <div v-if="isInitializing" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>Initializing video call...</p>
            </div>
        </div>

        <!-- Video Grid -->
        <div class="video-grid" ref="videoGrid" :class="{ 'focused-active': focusedPeerId, 'facetime-active': facetimeActive }">

            <!-- Local video container (can be primary or PiP) -->
            <div 
                 :class="[
                   'video-container local-video',
                   aspectClasses['local'],
                   { 
                     'primary': facetimeActive && primaryPeerId === 'local',
                     'pip': facetimeActive && secondaryPeerId === 'local',
                     'pip-top-right': facetimeActive && secondaryPeerId === 'local' && pipCorner === 'top-right',
                     'pip-top-left': facetimeActive && secondaryPeerId === 'local' && pipCorner === 'top-left',
                     'pip-bottom-right': facetimeActive && secondaryPeerId === 'local' && pipCorner === 'bottom-right',
                     'pip-bottom-left': facetimeActive && secondaryPeerId === 'local' && pipCorner === 'bottom-left',
                     'pip-custom': facetimeActive && secondaryPeerId === 'local' && pipCorner === 'custom',
                     'focused': focusedPeerId === 'local',
                     'hidden': facetimeActive && primaryPeerId !== 'local' && secondaryPeerId !== 'local' ? true : (focusedPeerId && focusedPeerId !== 'local')
                   }
                 ]"
                 :style="pipStyle('local')"
                 ref="localContainer"
                 @dblclick="facetimeActive ? swapPrimaryAndSecondary() : onTileDoubleClick('local')"
                 @click="onTileTap('local')"
                 @pointerdown="facetimeActive && secondaryPeerId === 'local' ? onPipPointerDown('local', $event) : null">
                <video 
                    ref="localVideo" 
                    autoplay 
                    muted 
                    playsinline
                    preload="none"
                ></video>
            </div>

            <!-- Remote videos -->
            <div 
                v-for="peer in remotePeers" 
                :key="peer.id" 
                :class="[
                  'video-container remote-video',
                  aspectClasses[peer.id],
                  { 
                    'primary': facetimeActive && primaryPeerId === peer.id,
                    'pip': facetimeActive && secondaryPeerId === peer.id,
                    'pip-top-right': facetimeActive && secondaryPeerId === peer.id && pipCorner === 'top-right',
                    'pip-top-left': facetimeActive && secondaryPeerId === peer.id && pipCorner === 'top-left',
                    'pip-bottom-right': facetimeActive && secondaryPeerId === peer.id && pipCorner === 'bottom-right',
                    'pip-bottom-left': facetimeActive && secondaryPeerId === peer.id && pipCorner === 'bottom-left',
                    'pip-custom': facetimeActive && secondaryPeerId === peer.id && pipCorner === 'custom',
                    'focused': focusedPeerId === peer.id,
                    'hidden': facetimeActive && primaryPeerId !== peer.id && secondaryPeerId !== peer.id ? true : (focusedPeerId && focusedPeerId !== peer.id)
                  }
                ]"
                :style="pipStyle(peer.id)"
                :ref="`remoteContainer-${peer.id}`"
                @dblclick="facetimeActive ? swapPrimaryAndSecondary() : onTileDoubleClick(peer.id)"
                @click="onTileTap(peer.id)"
                @pointerdown="facetimeActive && secondaryPeerId === peer.id ? onPipPointerDown(peer.id, $event) : null">
                <video 
                    :ref="`remoteVideo-${peer.id}`"
                    autoplay 
                    playsinline
                    preload="none"
                ></video>
            </div>
            </div>
  
         <!-- Error Display -->
        <div v-if="showErrorOverlay" class="error-overlay">
            <div class="error-message">
                <h3>‚ö†Ô∏è Connection Error</h3>
                <p>{{ connectionStatus.message }}</p>
                <div class="error-solutions">
                    <h4>Possible Solutions:</h4>
                    <ul>
                        <li>Make sure you're accessing via <strong>https://</strong> or <strong>localhost</strong></li>
                        <li>Allow camera and microphone permissions when prompted</li>
                        <li>Use a modern browser (Chrome, Firefox, Safari, Edge)</li>
                        <li>Check if your browser supports WebRTC</li>
                    </ul>
                    <button @click="retryConnection" class="retry-btn">Retry Connection</button>
                </div>
            </div>
        </div>

        <!-- Remote Controls for Room Creator -->
        <div v-if="isRoomCreator && showRemoteControls" class="remote-controls-overlay">
            <div class="remote-controls">
                <div class="remote-controls-header">
                    <h3>üë• Control Participants</h3>
                    <button @click="toggleRemoteControls" class="close-btn">‚úï</button>
                </div>
                
                <div v-for="peer in remotePeers" :key="peer.id" class="peer-controls">
                    <h4>{{ peer.username || 'Participant' }}</h4>
                    <div class="control-buttons">
                        <button @click="controlRemoteVideo(peer.id, true)" class="control-btn video-btn">
                            üìπ Turn On Video
                        </button>
                        <button @click="controlRemoteVideo(peer.id, false)" class="control-btn video-btn">
                            üìπ Turn Off Video
                        </button>
                        <button @click="controlRemoteAudio(peer.id, true)" class="control-btn audio-btn">
                            üé§ Turn On Mic
                        </button>
                        <button @click="controlRemoteAudio(peer.id, false)" class="control-btn audio-btn">
                            üé§ Turn Off Mic
                        </button>
                    </div>
                </div>
                
                <div v-if="remotePeers.length === 0" class="no-participants">
                    <p>No other participants to control yet.</p>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div :class="['controls', 'overlay-controls', overlayPosition]">
            <!-- Microphone Control Group -->
            <div class="control-group">
                <button 
                    @click="toggleMicrophone" 
                    :class="['control-btn', 'main-btn', micEnabled ? 'mic-on' : 'mic-off']" 
                    title="Toggle Microphone"
                >
                    <svg v-if="micEnabled" class="mic-icon" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                    <svg v-else class="mic-off-icon" viewBox="0 0 24 24">
                        <path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c.57-.08 1.12-.23 1.64-.46l2.36 2.36L21 18.73 4.27 3z"/>
                    </svg>
                </button>
                
                <button 
                    v-if="availableMics.length > 1"
                    @click="toggleMicDropdown" 
                    class="control-btn secondary-btn mic-switcher" 
                    title="Switch Microphone"
                >
                    <svg class="dropdown-arrow" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
                
                <!-- Microphone Dropdown -->
                <div v-if="showMicDropdown && availableMics.length > 1" 
                     class="mic-dropdown"
                     @click.stop
                >
                    <div class="dropdown-header">
                        <span>Select Microphone</span>
                        <button @click="toggleMicDropdown" class="close-dropdown">√ó</button>
                    </div>
                    <div class="mic-list">
                        <div 
                            v-for="(mic, index) in availableMics" 
                            :key="mic.deviceId"
                            :class="['mic-option', { 'active': index === currentMicIndex }]"
                            @click="selectMic(index)"
                        >
                            <div class="mic-info">
                                <span class="mic-name">{{ mic.label || `Microphone ${index + 1}` }}</span>
                                <span v-if="index === currentMicIndex" class="current-indicator">Current</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Control Group -->
            <div class="control-group">
                <button 
                    @click="toggleVideo" 
                    :class="['control-btn', 'main-btn', videoEnabled ? 'video-on' : 'video-off']" 
                    title="Toggle Video"
                >
                    <svg v-if="videoEnabled" class="video-icon" viewBox="0 0 24 24">
                        <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                    </svg>
                    <svg v-else class="video-off-icon" viewBox="0 0 24 24">
                        <path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H9.82l8.18 8.18V6.5zM3.27 2L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.54-.18L19.73 21 21 19.73 3.27 2z"/>
                    </svg>
                </button>
                
                <button 
                    v-if="availableCameras.length > 1"
                    @click="toggleCameraDropdown" 
                    class="control-btn secondary-btn camera-switcher" 
                    title="Switch Camera"
                >
                    <svg class="dropdown-arrow" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
                
                <!-- Camera Dropdown -->
                <div v-if="showCameraDropdown && availableCameras.length > 1" 
                     class="camera-dropdown"
                     @click.stop
                >
                    <div class="dropdown-header">
                        <span>Select Camera</span>
                        <button @click="toggleCameraDropdown" class="close-dropdown">√ó</button>
                    </div>
                    <div class="camera-list">
                        <div 
                            v-for="(camera, index) in availableCameras" 
                            :key="camera.deviceId"
                            :class="['camera-option', { 'active': index === currentCameraIndex }]"
                            @click="selectCamera(index)"
                        >
                            <div class="camera-info">
                                <span class="camera-name">{{ camera.label || `Camera ${index + 1}` }}</span>
                                <span v-if="index === currentCameraIndex" class="current-indicator">Current</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <button 
                v-if="focusedPeerId"
                @click="exitFocused" 
                class="control-btn main-btn tile-view-btn" 
                title="Tile View"
            >
                <svg class="tile-view-icon" viewBox="0 0 24 24">
                    <path d="M4 4h6v6H4V4zm0 10h6v6H4v-6zM14 4h6v6h-6V4zm0 10h6v6h-6v-6z"/>
                </svg>
            </button>

            <!-- FaceTime Controls -->
            <button 
                @click="toggleFaceTime" 
                :class="['control-btn', 'main-btn', facetimeActive ? 'facetime-on' : 'facetime-off']" 
                title="Toggle FaceTime Layout"
            >
                <svg v-if="!facetimeActive" class="facetime-icon" viewBox="0 0 24 24">
                    <path d="M4 6h10v8H4zM16 8l4-2v8l-4-2z"/>
                </svg>
                <svg v-else class="pip-icon" viewBox="0 0 24 24">
                    <path d="M3 5h18v14H3V5zm10 7H5v6h8v-6z"/>
                </svg>
            </button>

            <button 
                v-if="facetimeActive && primaryPeerId" 
                @click="swapPrimaryAndSecondary" 
                class="control-btn secondary-btn swap-btn" 
                title="Swap Feeds"
            >
                <svg class="swap-icon" viewBox="0 0 24 24">
                    <path d="M7 7h10v2H7V7zm0 8h10v2H7v-2zM8 12l-4 4V8l4 4zm8 0l4-4v8l-4-4z"/>
                </svg>
            </button>

            <button 
                @click="hangUp" 
                class="control-btn hang-up" 
                title="Leave Meeting"
            >
                <svg class="hang-up-icon" viewBox="0 0 24 24">
                    <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.7l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28-.79-.73-1.68-1.36-2.66-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
                </svg>
            </button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/webtransport-client.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="/crypto-client.js"></script>
    <script src="/webrtc-client.js"></script>
    <script src="/room-vue.js"></script>
</body>
</html>